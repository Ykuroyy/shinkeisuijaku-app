<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ ç¥çµŒè¡°å¼±ã‚²ãƒ¼ãƒ  ğŸŒ¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .title {
            font-size: 3rem;
            color: #ff6b9d;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            font-weight: bold;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .score-board {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
        }

        .score-item {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .matched-cards {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .matched-card {
            background: white;
            border-radius: 8px;
            padding: 5px;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: scale(0.8);
            transition: all 0.3s ease;
            animation: cardMove 0.5s ease-out;
        }

        .matched-card:hover {
            transform: scale(0.9);
        }

        @keyframes cardMove {
            0% {
                transform: scale(0.5) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.7;
            }
            100% {
                transform: scale(0.8) rotate(360deg);
                opacity: 1;
            }
        }

        .empty-space {
            background: transparent !important;
            box-shadow: none !important;
            border: 2px dashed #ddd;
            opacity: 0.3;
        }

        /* ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes sparkle {
            0% { 
                transform: scale(1) rotate(0deg) translateY(0px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            25% { 
                transform: scale(1.1) rotate(90deg) translateY(-10px);
                box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
            }
            50% { 
                transform: scale(1.2) rotate(180deg) translateY(-20px);
                box-shadow: 0 12px 35px rgba(255, 215, 0, 0.8);
            }
            75% { 
                transform: scale(1.1) rotate(270deg) translateY(-10px);
                box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
            }
            100% { 
                transform: scale(1) rotate(360deg) translateY(0px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
        }

        /* ã‚«ãƒ¼ãƒ‰è‡ªä½“ã®å›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes cardRotate {
            0% { 
                transform: rotateY(0deg) rotate(0deg);
            }
            25% { 
                transform: rotateY(0deg) rotate(90deg);
            }
            50% { 
                transform: rotateY(0deg) rotate(180deg);
            }
            75% { 
                transform: rotateY(0deg) rotate(270deg);
            }
            100% { 
                transform: rotateY(0deg) rotate(360deg);
            }
        }

        /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shuffle {
            0% { 
                transform: translateX(0px) translateY(0px) rotate(0deg);
            }
            25% { 
                transform: translateX(20px) translateY(-30px) rotate(90deg);
            }
            50% { 
                transform: translateX(-15px) translateY(25px) rotate(180deg);
            }
            75% { 
                transform: translateX(25px) translateY(-20px) rotate(270deg);
            }
            100% { 
                transform: translateX(0px) translateY(0px) rotate(360deg);
            }
        }

        .shuffle-effect {
            animation: shuffle 0.8s ease-in-out;
            background: linear-gradient(45deg, #ff6b9d, #ff9a9e) !important;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5) !important;
        }

        .sparkle-effect {
            animation: cardRotate 2s ease-in-out infinite;
            position: relative;
            z-index: 100;
            background: linear-gradient(45deg, #ffd700, #ffed4e) !important;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5) !important;
            transform: rotateY(0deg) !important;
        }

        .sparkle-effect::before {
            content: 'âœ¨';
            position: absolute;
            top: -15px;
            left: -15px;
            font-size: 25px;
            animation: sparkle 1s ease-in-out infinite;
            z-index: 10;
        }

        .sparkle-effect::after {
            content: 'âœ¨';
            position: absolute;
            bottom: -15px;
            right: -15px;
            font-size: 25px;
            animation: sparkle 1s ease-in-out infinite 0.5s;
            z-index: 10;
        }

        .sparkle-effect .card-front {
            color: #333 !important;
            font-weight: bold !important;
            transform: rotateY(0deg) !important;
        }

        .turn-indicator {
            font-size: 1.3rem;
            color: #ff6b9d;
            font-weight: bold;
            margin: 10px 0;
        }



        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b9d, #ff9a9e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .card {
            aspect-ratio: 1;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            transform-style: preserve-3d;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card:hover .card-back {
            background: linear-gradient(135deg, #ff8fa3 0%, #fecfef 50%, #ffa6d4 100%);
        }

        .card:hover .card-back::before,
        .card:hover .card-back::after {
            opacity: 1;
            transform: scale(1.1);
            transition: all 0.3s ease;
        }

        .card.flipped {
            background: white;
            transform: rotateY(180deg);
        }

        .card.matched {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            transform: scale(0.9);
            opacity: 0.9;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            cursor: default;
        }

        .card.matched .card-front {
            color: #333;
            font-weight: bold;
        }

        .card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffb3d9 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            backface-visibility: hidden;
            position: relative;
            overflow: hidden;
        }

        .card-back::before {
            content: 'ğŸŒ¸';
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 1rem;
            opacity: 0.7;
        }

        .card-back::after {
            content: 'âœ¨';
            position: absolute;
            bottom: 10%;
            right: 10%;
            font-size: 1rem;
            opacity: 0.7;
        }

        .card-back .card-pattern {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .card-back .main-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .card-back .sub-icons {
            display: flex;
            gap: 8px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .card-front {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            backface-visibility: hidden;
            transform: rotateY(180deg);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .game-over h2 {
            color: #ff6b9d;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .game-over p {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                padding: 15px;
            }
            
            .card {
                font-size: 2rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ğŸŒ¸ ç¥çµŒè¡°å¼±ã‚²ãƒ¼ãƒ  ğŸŒ¸</h1>
        <p class="subtitle">å¯æ„›ã„ã‚«ãƒ¼ãƒ‰ã‚’æƒãˆã¦AIã¨å¯¾æˆ¦ã—ã‚ˆã†ï¼</p>

        <div class="game-controls">
            <button class="btn" id="new-game-btn">ğŸ® æ–°ã—ã„ã‚²ãƒ¼ãƒ </button>
        </div>

        <div class="game-info">
            <div class="score-board">
                <div class="score-item">
                    <div>ã‚ãªãŸ</div>
                    <div id="player-score">0</div>
                    <div class="matched-cards" id="player-matched-cards"></div>
                </div>
                <div class="score-item">
                    <div>AI</div>
                    <div id="ai-score">0</div>
                    <div class="matched-cards" id="ai-matched-cards"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="flip-back-btn" style="display: none;">ğŸ”„ ã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™</button>
            <button class="btn" id="ai-btn" style="display: none;">ğŸ¤– AIã®ã‚¿ãƒ¼ãƒ³ã§ã™</button>
        </div>

        <div class="game-board" id="game-board">
            <!-- ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
    </div>

    <div class="game-over" id="game-over" style="display: none;">
        <div class="game-over-content">
            <h2 id="game-result">ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
            <p id="final-score"></p>
            <button class="btn" onclick="startNewGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
        </div>
    </div>

    <script>
        let gameState = {
            cards: [],
            flipped: [],
            matched: [],
            playerScore: 0,
            aiScore: 0,
            currentTurn: 'player',
            firstCard: null,
            secondCard: null,
            waitingForSecond: false
        };

        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
        function initGame() {
            fetch('/api/new-game')
                .then(response => response.json())
                .then(data => {
                    gameState = {
                        cards: data.cards,
                        flipped: data.flipped,
                        matched: data.matched,
                        playerScore: data.player_score,
                        aiScore: data.ai_score,
                        currentTurn: data.current_turn,
                        firstCard: null,
                        secondCard: null,
                        waitingForSecond: false,
                        player_matched_cards: data.player_matched_cards || [],
                        ai_matched_cards: data.ai_matched_cards || []
                    };
                    renderGame();
                });
        }

        // ã‚²ãƒ¼ãƒ ç”»é¢ã‚’æç”»
        function renderGame() {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';

            for (let i = 0; i < 20; i++) {
                if (gameState.matched[i]) {
                    // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã®å ´åˆã¯ç©ºã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆ
                    const emptySpace = document.createElement('div');
                    emptySpace.className = 'card empty-space';
                    emptySpace.style.visibility = 'hidden';
                    gameBoard.appendChild(emptySpace);
                } else {
                    // é€šå¸¸ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.index = i;

                    if (gameState.flipped[i]) {
                        card.classList.add('flipped');
                    }

                    const cardBack = document.createElement('div');
                    cardBack.className = 'card-back';
                    cardBack.innerHTML = `
                        <div class="card-pattern">
                            <div class="main-icon">ğŸ€</div>
                            <div class="sub-icons">
                                <span>ğŸ’–</span>
                                <span>â­</span>
                                <span>ğŸŒº</span>
                            </div>
                        </div>
                    `;

                    const cardFront = document.createElement('div');
                    cardFront.className = 'card-front';
                    cardFront.innerHTML = gameState.cards[i];

                    card.appendChild(cardBack);
                    card.appendChild(cardFront);

                    card.addEventListener('click', () => handleCardClick(i));
                    gameBoard.appendChild(card);
                }
            }

            document.getElementById('player-score').textContent = gameState.playerScore;
            document.getElementById('ai-score').textContent = gameState.aiScore;
            
            // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
            renderMatchedCards();
        }

        // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        function handleCardClick(cardIndex) {
            if (gameState.currentTurn !== 'player' || gameState.matched[cardIndex] || gameState.flipped[cardIndex]) {
                return;
            }

            fetch('/api/flip-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ card_index: cardIndex })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }

                const prevFirst = gameState.firstCard;
                const prevSecond = data.second_card;

                // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹å‰ï¼‰
                const newMatchedCards = [];
                for (let i = 0; i < data.matched.length; i++) {
                    if (data.matched[i] && !gameState.matched[i]) {
                        newMatchedCards.push(i);
                    }
                }

                gameState.flipped = data.flipped;
                gameState.matched = data.matched;
                gameState.playerScore = data.player_score;
                gameState.aiScore = data.ai_score;
                gameState.currentTurn = data.current_turn;
                gameState.firstCard = data.first_card;
                gameState.secondCard = data.second_card;
                gameState.player_matched_cards = data.player_matched_cards;
                gameState.ai_matched_cards = data.ai_matched_cards;

                // æ–°ã—ããƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’è¡¨ç¤ºï¼ˆrenderGameã¯å‘¼ã°ãªã„ï¼‰
                if (newMatchedCards.length > 0) {
                    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®ã¿æ›´æ–°
                    document.getElementById('player-score').textContent = gameState.playerScore;
                    document.getElementById('ai-score').textContent = gameState.aiScore;
                    
                    // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨å‘ãã«ã™ã‚‹
                    newMatchedCards.forEach(cardIndex => {
                        const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                        if (cardElement) {
                            cardElement.classList.add('flipped');
                        }
                    });
                    
                    showSparkleEffect(newMatchedCards);
                } else {
                    // ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã¯é€šå¸¸é€šã‚ŠrenderGameã‚’å‘¼ã¶
                    renderGame();
                }

                // 2æšç›®ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸ã‚“ã å ´åˆã®å‡¦ç†
                if (data.current_turn === 'ai') {
                    // AIã®ã‚¿ãƒ¼ãƒ³ã«ãªã£ãŸå ´åˆ
                    if (prevFirst !== null && prevSecond !== null && !data.matched[prevFirst] && !data.matched[prevSecond]) {
                        // ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆï¼šã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                        document.getElementById('flip-back-btn').style.display = 'inline-block';
                        document.getElementById('ai-btn').style.display = 'none';
                    } else if (data.matched && data.matched.filter(m => m).length > gameState.matched.filter(m => m).length) {
                        // ãƒãƒƒãƒã—ãŸå ´åˆï¼š2ç§’å¾Œã«AIã®ã‚¿ãƒ¼ãƒ³
                        setTimeout(() => {
                            handleAITurn();
                        }, 2000);
                    }
                } else {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆï¼šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                    document.getElementById('flip-back-btn').style.display = 'none';
                    document.getElementById('ai-btn').style.display = 'none';
                }

                // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
                checkGameEnd();
            });
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™å‡¦ç†
        function flipBackCards() {
            // ç¾åœ¨è¡¨ã«ãªã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’è£ã«æˆ»ã™
            const flippedCards = gameState.flipped.map((flipped, index) => ({ flipped, index })).filter(card => card.flipped && !gameState.matched[card.index]);
            
            if (flippedCards.length >= 2) {
                // æœ€åˆã®2æšã‚’è£ã«æˆ»ã™
                gameState.flipped[flippedCards[0].index] = false;
                gameState.flipped[flippedCards[1].index] = false;
                
                renderGame();
                
                // ã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                document.getElementById('flip-back-btn').style.display = 'none';
                
                // AIã®ã‚¿ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('ai-btn').style.display = 'inline-block';
            }
        }

        // AIã®ã‚¿ãƒ¼ãƒ³å‡¦ç†
        function handleAITurn() {
            console.log('AIã‚¿ãƒ¼ãƒ³é–‹å§‹');
            // AIã®ã‚¿ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            document.getElementById('ai-btn').style.display = 'none';
            
            fetch('/api/ai-turn')
                .then(response => response.json())
                .then(data => {
                    console.log('AIã‚¿ãƒ¼ãƒ³ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', data);
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }

                    // AIãŒé¸ã‚“ã ã‚«ãƒ¼ãƒ‰ã‚’ä¸€ç¬è¡¨ç¤º
                    if (data.ai_first_card !== undefined && data.ai_second_card !== undefined) {
                        // AIãŒé¸ã‚“ã 2æšã‚’è¡¨ã«ã™ã‚‹
                        gameState.flipped[data.ai_first_card] = true;
                        gameState.flipped[data.ai_second_card] = true;
                        gameState.currentTurn = 'ai';
                        renderGame();
                        
                        // 1ç§’å¾Œã«çµæœã‚’å‡¦ç†
                        setTimeout(() => {
                            if (data.current_turn === 'ai') {
                                // AIãŒãƒãƒƒãƒã—ãŸå ´åˆã€ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰ç¶šè¡Œ
                                const newMatchedCards = [];
                                for (let i = 0; i < data.matched.length; i++) {
                                    if (data.matched[i] && !gameState.matched[i]) {
                                        newMatchedCards.push(i);
                                    }
                                }
                                
                                gameState.flipped = data.flipped;
                                gameState.matched = data.matched;
                                gameState.playerScore = data.player_score;
                                gameState.aiScore = data.ai_score;
                                gameState.currentTurn = data.current_turn;
                                gameState.player_matched_cards = data.player_matched_cards;
                                gameState.ai_matched_cards = data.ai_matched_cards;
                                
                                if (newMatchedCards.length > 0) {
                                    // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®ã¿æ›´æ–°
                                    document.getElementById('player-score').textContent = gameState.playerScore;
                                    document.getElementById('ai-score').textContent = gameState.aiScore;
                                    
                                    // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨å‘ãã«ã™ã‚‹
                                    newMatchedCards.forEach(cardIndex => {
                                        const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                                        if (cardElement) {
                                            cardElement.classList.add('flipped');
                                        }
                                    });
                                    
                                    showSparkleEffect(newMatchedCards);
                                    
                                    // AIãŒãƒãƒƒãƒã—ãŸå ´åˆã€ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœçµ‚äº†å¾Œã«AIãŒç¶šè¡Œ
                                    setTimeout(() => {
                                        if (gameState.currentTurn === 'ai') {
                                            handleAITurn();
                                        }
                                    }, 5000); // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœï¼ˆ4ç§’ï¼‰+ 1ç§’å¾…æ©Ÿ
                                } else {
                                    // ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã¯é€šå¸¸é€šã‚ŠrenderGameã‚’å‘¼ã¶
                                    renderGame();
                                }
                            } else {
                                // AIãŒãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆã€ã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                                gameState.currentTurn = data.current_turn;
                                document.getElementById('ai-btn').style.display = 'none';
                                document.getElementById('flip-back-btn').style.display = 'inline-block';
                            }
                        }, 1000);
                    } else {
                        // é€šå¸¸ã®å‡¦ç†
                        gameState.flipped = data.flipped;
                        gameState.matched = data.matched;
                        gameState.playerScore = data.player_score;
                        gameState.aiScore = data.ai_score;
                        gameState.currentTurn = data.current_turn;
                        gameState.player_matched_cards = data.player_matched_cards;
                        gameState.ai_matched_cards = data.ai_matched_cards;
                        renderGame();
                    }

                    // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
                    checkGameEnd();
                })
                .catch(error => {
                    console.error('AIã‚¿ãƒ¼ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                });
        }



        // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        function renderMatchedCards() {
            const playerMatchedCards = document.getElementById('player-matched-cards');
            const aiMatchedCards = document.getElementById('ai-matched-cards');
            
            // æ—¢å­˜ã®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            playerMatchedCards.innerHTML = '';
            aiMatchedCards.innerHTML = '';
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆãƒšã‚¢ã”ã¨ã«1æšãšã¤ï¼‰
            if (gameState.player_matched_cards) {
                for (let i = 0; i < gameState.player_matched_cards.length; i += 2) {
                    const cardIndex = gameState.player_matched_cards[i];
                    const cardElement = document.createElement('div');
                    cardElement.className = 'matched-card';
                    cardElement.innerHTML = gameState.cards[cardIndex];
                    playerMatchedCards.appendChild(cardElement);
                }
            }
            
            // AIãŒãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆãƒšã‚¢ã”ã¨ã«1æšãšã¤ï¼‰
            if (gameState.ai_matched_cards) {
                for (let i = 0; i < gameState.ai_matched_cards.length; i += 2) {
                    const cardIndex = gameState.ai_matched_cards[i];
                    const cardElement = document.createElement('div');
                    cardElement.className = 'matched-card';
                    cardElement.innerHTML = gameState.cards[cardIndex];
                    aiMatchedCards.appendChild(cardElement);
                }
            }
        }

        // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’è¡¨ç¤º
        function showSparkleEffect(matchedCardIndices) {
            console.log('ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœé–‹å§‹:', matchedCardIndices);
            // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœä¸­ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            window.isSparkling = true;
            
            // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœé–‹å§‹æ™‚ã«ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
            renderMatchedCards();
            
            // ã¾ãš1ç§’é–“ã€ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨å‘ãã§è¡¨ç¤ºï¼ˆã‚­ãƒ©ã‚­ãƒ©åŠ¹æœãªã—ï¼‰
            setTimeout(() => {
                // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’è¡¨ç¤º
                matchedCardIndices.forEach(cardIndex => {
                    const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                    if (cardElement) {
                        console.log(`ã‚«ãƒ¼ãƒ‰ ${cardIndex} ã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’é©ç”¨`);
                        // ã‚«ãƒ¼ãƒ‰ã‚’è¡¨å‘ãã«ã—ã¦ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’é©ç”¨
                        cardElement.classList.add('flipped');
                        cardElement.classList.add('sparkle-effect');
                    } else {
                        console.log(`ã‚«ãƒ¼ãƒ‰ ${cardIndex} ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    }
                });
                
                // 4ç§’å¾Œã«ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœã‚’å‰Šé™¤ã—ã€ã‚«ãƒ¼ãƒ‰ã‚’ç©ºç™½ã«ã—ã¦ã‚¢ã‚¤ã‚³ãƒ³ã«ç§»å‹•
                setTimeout(() => {
                    matchedCardIndices.forEach(cardIndex => {
                        const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                        if (cardElement) {
                            cardElement.classList.remove('sparkle-effect');
                            // ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ç©ºç™½ã«ã™ã‚‹
                            cardElement.style.visibility = 'hidden';
                            console.log(`ã‚«ãƒ¼ãƒ‰ ${cardIndex} ã®ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœçµ‚äº†`);
                        }
                    });
                    // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœä¸­ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
                    window.isSparkling = false;
                    // ã‚¢ã‚¤ã‚³ãƒ³ã®å ´æ‰€ã«ãƒãƒƒãƒã—ãŸã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºï¼ˆå†åº¦æ›´æ–°ï¼‰
                    renderMatchedCards();
                    
                    // ã‚­ãƒ©ã‚­ãƒ©åŠ¹æœçµ‚äº†å¾Œã«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ç¢ºèª
                    if (gameState.currentTurn === 'player') {
                        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆï¼šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                        document.getElementById('flip-back-btn').style.display = 'none';
                        document.getElementById('ai-btn').style.display = 'none';
                    } else if (gameState.currentTurn === 'ai') {
                        // AIã®ã‚¿ãƒ¼ãƒ³ã®å ´åˆï¼šAIãŒç¶šè¡Œ
                        setTimeout(() => {
                            handleAITurn();
                        }, 1000);
                    }
                }, 4000);
            }, 1000);
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†ãƒã‚§ãƒƒã‚¯
        function checkGameEnd() {
            const matchedCount = gameState.matched.filter(m => m).length;
            if (matchedCount === 20) {
                setTimeout(() => {
                    showGameOver();
                }, 1000);
            }
        }

        // ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢è¡¨ç¤º
        function showGameOver() {
            const gameOver = document.getElementById('game-over');
            const gameResult = document.getElementById('game-result');
            const finalScore = document.getElementById('final-score');

            let resultText = '';
            if (gameState.playerScore > gameState.aiScore) {
                resultText = 'ğŸ‰ ã‚ãªãŸã®å‹åˆ©ï¼ ğŸ‰';
            } else if (gameState.playerScore < gameState.aiScore) {
                resultText = 'ğŸ˜… AIã®å‹åˆ©...';
            } else {
                resultText = 'ğŸ¤ å¼•ãåˆ†ã‘ï¼';
            }

            gameResult.textContent = resultText;
            finalScore.textContent = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ã‚ãªãŸ ${gameState.playerScore} - ${gameState.aiScore} AI`;

            gameOver.style.display = 'flex';
        }

        // æ–°ã—ã„ã‚²ãƒ¼ãƒ é–‹å§‹
        function startNewGame() {
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('flip-back-btn').style.display = 'none';
            document.getElementById('ai-btn').style.display = 'none';
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            showShuffleAnimation();
        }

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function showShuffleAnimation() {
            const gameBoard = document.getElementById('game-board');
            const cards = gameBoard.querySelectorAll('.card');
            
            // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«åŠ¹æœã‚’é©ç”¨
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('shuffle-effect');
                }, index * 50); // ã‚«ãƒ¼ãƒ‰ã”ã¨ã«å°‘ã—ãšã¤é…å»¶
            });
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹
            setTimeout(() => {
                cards.forEach(card => {
                    card.classList.remove('shuffle-effect');
                });
                initGame();
            }, cards.length * 50 + 800); // å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ™‚é–“
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);
        document.getElementById('ai-btn').addEventListener('click', handleAITurn);
        document.getElementById('flip-back-btn').addEventListener('click', flipBackCards);

        // åˆæœŸåŒ–
        initGame();
    </script>
</body>
</html> 