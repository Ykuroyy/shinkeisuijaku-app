<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå∏ Á•ûÁµåË°∞Âº±„Ç≤„Éº„É† üå∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        .title {
            font-size: 3rem;
            color: #ff6b9d;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            font-weight: bold;
        }

        .subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 15px;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .score-board {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-bottom: 20px;
        }

        .score-item {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .matched-cards {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
        }

        .matched-card {
            background: white;
            border-radius: 8px;
            padding: 5px;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transform: scale(0.8);
            transition: all 0.3s ease;
            animation: cardMove 0.5s ease-out;
        }

        .matched-card:hover {
            transform: scale(0.9);
        }

        @keyframes cardMove {
            0% {
                transform: scale(0.5) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.7;
            }
            100% {
                transform: scale(0.8) rotate(360deg);
                opacity: 1;
            }
        }

        .empty-space {
            background: transparent !important;
            box-shadow: none !important;
            border: 2px dashed #ddd;
            opacity: 0.3;
        }

        /* „Ç≠„É©„Ç≠„É©ÂäπÊûú„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes sparkle {
            0% { 
                transform: scale(1) rotate(0deg) translateY(0px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            25% { 
                transform: scale(1.1) rotate(90deg) translateY(-10px);
                box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
            }
            50% { 
                transform: scale(1.2) rotate(180deg) translateY(-20px);
                box-shadow: 0 12px 35px rgba(255, 215, 0, 0.8);
            }
            75% { 
                transform: scale(1.1) rotate(270deg) translateY(-10px);
                box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
            }
            100% { 
                transform: scale(1) rotate(360deg) translateY(0px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
        }

        /* „Ç´„Éº„ÉâËá™‰Ωì„ÅÆÂõûËª¢„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes cardRotate {
            0% { 
                transform: rotateY(0deg) rotate(0deg);
            }
            25% { 
                transform: rotateY(0deg) rotate(90deg);
            }
            50% { 
                transform: rotateY(0deg) rotate(180deg);
            }
            75% { 
                transform: rotateY(0deg) rotate(270deg);
            }
            100% { 
                transform: rotateY(0deg) rotate(360deg);
            }
        }

        /* „Ç∑„É£„ÉÉ„Éï„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes shuffle {
            0% { 
                transform: translateX(0px) translateY(0px) rotate(0deg);
            }
            25% { 
                transform: translateX(20px) translateY(-30px) rotate(90deg);
            }
            50% { 
                transform: translateX(-15px) translateY(25px) rotate(180deg);
            }
            75% { 
                transform: translateX(25px) translateY(-20px) rotate(270deg);
            }
            100% { 
                transform: translateX(0px) translateY(0px) rotate(360deg);
            }
        }

        .shuffle-effect {
            animation: shuffle 0.8s ease-in-out;
            background: linear-gradient(45deg, #ff6b9d, #ff9a9e) !important;
            box-shadow: 0 8px 25px rgba(255, 107, 157, 0.5) !important;
        }

        .sparkle-effect {
            animation: cardRotate 2s ease-in-out infinite;
            position: relative;
            z-index: 100;
            background: linear-gradient(45deg, #ffd700, #ffed4e) !important;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5) !important;
            transform: rotateY(0deg) !important;
        }

        .sparkle-effect::before {
            content: '‚ú®';
            position: absolute;
            top: -15px;
            left: -15px;
            font-size: 25px;
            animation: sparkle 1s ease-in-out infinite;
            z-index: 10;
        }

        .sparkle-effect::after {
            content: '‚ú®';
            position: absolute;
            bottom: -15px;
            right: -15px;
            font-size: 25px;
            animation: sparkle 1s ease-in-out infinite 0.5s;
            z-index: 10;
        }

        .sparkle-effect .card-front {
            color: #333 !important;
            font-weight: bold !important;
            transform: rotateY(0deg) !important;
        }

        .turn-indicator {
            font-size: 1.3rem;
            color: #ff6b9d;
            font-weight: bold;
            margin: 10px 0;
        }



        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b9d, #ff9a9e);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .game-board {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .card {
            aspect-ratio: 1;
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            transform-style: preserve-3d;
        }

        .card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card:hover .card-back {
            background: linear-gradient(135deg, #ff8fa3 0%, #fecfef 50%, #ffa6d4 100%);
        }

        .card:hover .card-back::before,
        .card:hover .card-back::after {
            opacity: 1;
            transform: scale(1.1);
            transition: all 0.3s ease;
        }

        .card.flipped {
            background: white;
            transform: rotateY(180deg);
        }

        .card.matched {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            transform: scale(0.9);
            opacity: 0.9;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            cursor: default;
        }

        .card.matched .card-front {
            color: #333;
            font-weight: bold;
        }

        .card-back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #ffb3d9 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            backface-visibility: hidden;
            position: relative;
            overflow: hidden;
        }

        .card-back::before {
            content: 'üå∏';
            position: absolute;
            top: 10%;
            left: 10%;
            font-size: 1rem;
            opacity: 0.7;
        }

        .card-back::after {
            content: '‚ú®';
            position: absolute;
            bottom: 10%;
            right: 10%;
            font-size: 1rem;
            opacity: 0.7;
        }

        .card-back .card-pattern {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .card-back .main-icon {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .card-back .sub-icons {
            display: flex;
            gap: 8px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .card-front {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            backface-visibility: hidden;
            transform: rotateY(180deg);
        }

        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .game-over-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .game-over h2 {
            color: #ff6b9d;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .game-over p {
            margin-bottom: 20px;
            font-size: 1.2rem;
        }

        .history-section {
            margin-top: 40px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .history-title {
            color: #ff6b9d;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .history-list {
            list-style: none;
            text-align: left;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .game-board {
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                padding: 15px;
            }
            
            .card {
                font-size: 2rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üå∏ Á•ûÁµåË°∞Âº±„Ç≤„Éº„É† üå∏</h1>
        <p class="subtitle">ÂèØÊÑõ„ÅÑ„Ç´„Éº„Éâ„ÇíÊèÉ„Åà„Å¶AI„Å®ÂØæÊà¶„Åó„Çà„ÅÜÔºÅ</p>

        <div class="game-controls">
            <button class="btn" id="new-game-btn">üéÆ Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†</button>
        </div>

        <div class="game-info">
            <div class="score-board">
                <div class="score-item">
                    <div>„ÅÇ„Å™„Åü</div>
                    <div id="player-score">0</div>
                    <div class="matched-cards" id="player-matched-cards"></div>
                </div>
                <div class="score-item">
                    <div>AI</div>
                    <div id="ai-score">0</div>
                    <div class="matched-cards" id="ai-matched-cards"></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="flip-back-btn" style="display: none;">üîÑ „Ç´„Éº„Éâ„ÇíË£èËøî„Åô</button>
            <button class="btn" id="ai-btn" style="display: none;">ü§ñ AI„ÅÆ„Çø„Éº„É≥„Åß„Åô</button>
        </div>

        <div class="game-board" id="game-board">
            <!-- „Ç´„Éº„Éâ„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
        </div>

        <div class="history-section">
            <h3 class="history-title">üìä „Ç≤„Éº„É†Â±•Ê≠¥</h3>
            <ul class="history-list" id="history-list">
                <!-- Â±•Ê≠¥„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
            </ul>
        </div>
    </div>

    <div class="game-over" id="game-over" style="display: none;">
        <div class="game-over-content">
            <h2 id="game-result">„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ</h2>
            <p id="final-score"></p>
            <button class="btn" onclick="startNewGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
        </div>
    </div>

    <script>
        let gameState = {
            cards: [],
            flipped: [],
            matched: [],
            playerScore: 0,
            aiScore: 0,
            currentTurn: 'player',
            firstCard: null,
            secondCard: null,
            waitingForSecond: false
        };

        // „Ç≤„Éº„É†ÂàùÊúüÂåñ
        function initGame() {
            fetch('/api/new-game')
                .then(response => response.json())
                .then(data => {
                    gameState = {
                        cards: data.cards,
                        flipped: data.flipped,
                        matched: data.matched,
                        playerScore: data.player_score,
                        aiScore: data.ai_score,
                        currentTurn: data.current_turn,
                        firstCard: null,
                        secondCard: null,
                        waitingForSecond: false,
                        player_matched_cards: data.player_matched_cards || [],
                        ai_matched_cards: data.ai_matched_cards || []
                    };
                    renderGame();
                });
        }

        // „Ç≤„Éº„É†ÁîªÈù¢„ÇíÊèèÁîª
        function renderGame() {
            const gameBoard = document.getElementById('game-board');
            gameBoard.innerHTML = '';

            for (let i = 0; i < 20; i++) {
                if (gameState.matched[i]) {
                    // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÁ©∫„ÅÆ„Çπ„Éö„Éº„Çπ„Çí‰ΩúÊàê
                    const emptySpace = document.createElement('div');
                    emptySpace.className = 'card empty-space';
                    emptySpace.style.visibility = 'hidden';
                    gameBoard.appendChild(emptySpace);
                } else {
                    // ÈÄöÂ∏∏„ÅÆ„Ç´„Éº„Éâ„Çí‰ΩúÊàê
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.index = i;

                    if (gameState.flipped[i]) {
                        card.classList.add('flipped');
                    }

                    const cardBack = document.createElement('div');
                    cardBack.className = 'card-back';
                    cardBack.innerHTML = `
                        <div class="card-pattern">
                            <div class="main-icon">üéÄ</div>
                            <div class="sub-icons">
                                <span>üíñ</span>
                                <span>‚≠ê</span>
                                <span>üå∫</span>
                            </div>
                        </div>
                    `;

                    const cardFront = document.createElement('div');
                    cardFront.className = 'card-front';
                    cardFront.innerHTML = gameState.cards[i];

                    card.appendChild(cardBack);
                    card.appendChild(cardFront);

                    card.addEventListener('click', () => handleCardClick(i));
                    gameBoard.appendChild(card);
                }
            }

            document.getElementById('player-score').textContent = gameState.playerScore;
            document.getElementById('ai-score').textContent = gameState.aiScore;
            
            // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Á§∫Ôºà„Ç≠„É©„Ç≠„É©ÂäπÊûú‰∏≠„ÅØÂëº„Å∞„Å™„ÅÑÔºâ
            if (!window.isSparkling) {
                renderMatchedCards();
            }
        }

        // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleCardClick(cardIndex) {
            if (gameState.currentTurn !== 'player' || gameState.matched[cardIndex] || gameState.flipped[cardIndex]) {
                return;
            }

            fetch('/api/flip-card', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ card_index: cardIndex })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }

                const prevFirst = gameState.firstCard;
                const prevSecond = data.second_card;

                // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç≤„Éº„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞„Åô„ÇãÂâçÔºâ
                const newMatchedCards = [];
                for (let i = 0; i < data.matched.length; i++) {
                    if (data.matched[i] && !gameState.matched[i]) {
                        newMatchedCards.push(i);
                    }
                }

                gameState.flipped = data.flipped;
                gameState.matched = data.matched;
                gameState.playerScore = data.player_score;
                gameState.aiScore = data.ai_score;
                gameState.currentTurn = data.current_turn;
                gameState.firstCard = data.first_card;
                gameState.secondCard = data.second_card;
                gameState.player_matched_cards = data.player_matched_cards;
                gameState.ai_matched_cards = data.ai_matched_cards;

                // Êñ∞„Åó„Åè„Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅ„Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíË°®Á§∫ÔºàrenderGame„ÅØÂëº„Å∞„Å™„ÅÑÔºâ
                if (newMatchedCards.length > 0) {
                    // „Çπ„Ç≥„Ç¢Ë°®Á§∫„ÅÆ„ÅøÊõ¥Êñ∞
                    document.getElementById('player-score').textContent = gameState.playerScore;
                    document.getElementById('ai-score').textContent = gameState.aiScore;
                    
                    // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Âêë„Åç„Å´„Åô„Çã
                    newMatchedCards.forEach(cardIndex => {
                        const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                        if (cardElement) {
                            cardElement.classList.add('flipped');
                        }
                    });
                    
                    showSparkleEffect(newMatchedCards);
                } else {
                    // „Éû„ÉÉ„ÉÅ„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØÈÄöÂ∏∏ÈÄö„ÇärenderGame„ÇíÂëº„Å∂
                    renderGame();
                }

                // 2ÊûöÁõÆ„ÅÆ„Ç´„Éº„Éâ„ÇíÈÅ∏„Çì„Å†Â†¥Âêà„ÅÆÂá¶ÁêÜ
                if (data.current_turn === 'ai') {
                    // AI„ÅÆ„Çø„Éº„É≥„Å´„Å™„Å£„ÅüÂ†¥Âêà
                    if (prevFirst !== null && prevSecond !== null && !data.matched[prevFirst] && !data.matched[prevSecond]) {
                        // „Éû„ÉÉ„ÉÅ„Åó„Å™„Åã„Å£„ÅüÂ†¥ÂêàÔºö„Ç´„Éº„Éâ„ÇíË£èËøî„Åô„Éú„Çø„É≥„ÇíË°®Á§∫
                        document.getElementById('flip-back-btn').style.display = 'inline-block';
                        document.getElementById('ai-btn').style.display = 'none';
                    } else if (data.matched && data.matched.filter(m => m).length > gameState.matched.filter(m => m).length) {
                        // „Éû„ÉÉ„ÉÅ„Åó„ÅüÂ†¥ÂêàÔºö2ÁßíÂæå„Å´AI„ÅÆ„Çø„Éº„É≥
                        setTimeout(() => {
                            handleAITurn();
                        }, 2000);
                    }
                } else {
                    // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„ÅÆÂ†¥ÂêàÔºö„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                    document.getElementById('flip-back-btn').style.display = 'none';
                    document.getElementById('ai-btn').style.display = 'none';
                }

                // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                checkGameEnd();
            });
        }

        // „Ç´„Éº„Éâ„ÇíË£èËøî„ÅôÂá¶ÁêÜ
        function flipBackCards() {
            // ÁèæÂú®Ë°®„Å´„Å™„Å£„Å¶„ÅÑ„Çã„Ç´„Éº„Éâ„ÇíË£è„Å´Êàª„Åô
            const flippedCards = gameState.flipped.map((flipped, index) => ({ flipped, index })).filter(card => card.flipped && !gameState.matched[card.index]);
            
            if (flippedCards.length >= 2) {
                // ÊúÄÂàù„ÅÆ2Êûö„ÇíË£è„Å´Êàª„Åô
                gameState.flipped[flippedCards[0].index] = false;
                gameState.flipped[flippedCards[1].index] = false;
                
                renderGame();
                
                // „Ç´„Éº„Éâ„ÇíË£èËøî„Åô„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                document.getElementById('flip-back-btn').style.display = 'none';
                
                // AI„ÅÆ„Çø„Éº„É≥„Éú„Çø„É≥„ÇíË°®Á§∫
                document.getElementById('ai-btn').style.display = 'inline-block';
            }
        }

        // AI„ÅÆ„Çø„Éº„É≥Âá¶ÁêÜ
        function handleAITurn() {
            console.log('AI„Çø„Éº„É≥ÈñãÂßã');
            // AI„ÅÆ„Çø„Éº„É≥„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
            document.getElementById('ai-btn').style.display = 'none';
            
            fetch('/api/ai-turn')
                .then(response => response.json())
                .then(data => {
                    console.log('AI„Çø„Éº„É≥„É¨„Çπ„Éù„É≥„Çπ:', data);
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }

                    // AI„ÅåÈÅ∏„Çì„Å†„Ç´„Éº„Éâ„Çí‰∏ÄÁû¨Ë°®Á§∫
                    if (data.ai_first_card !== undefined && data.ai_second_card !== undefined) {
                        // AI„ÅåÈÅ∏„Çì„Å†2Êûö„ÇíË°®„Å´„Åô„Çã
                        gameState.flipped[data.ai_first_card] = true;
                        gameState.flipped[data.ai_second_card] = true;
                        gameState.currentTurn = 'ai';
                        renderGame();
                        
                        // 1ÁßíÂæå„Å´ÁµêÊûú„ÇíÂá¶ÁêÜ
                        setTimeout(() => {
                            if (data.current_turn === 'ai') {
                                // AI„Åå„Éû„ÉÉ„ÉÅ„Åó„ÅüÂ†¥Âêà„ÄÅ„Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíË°®Á§∫„Åó„Å¶„Åã„ÇâÁ∂öË°å
                                const newMatchedCards = [];
                                for (let i = 0; i < data.matched.length; i++) {
                                    if (data.matched[i] && !gameState.matched[i]) {
                                        newMatchedCards.push(i);
                                    }
                                }
                                
                                gameState.flipped = data.flipped;
                                gameState.matched = data.matched;
                                gameState.playerScore = data.player_score;
                                gameState.aiScore = data.ai_score;
                                gameState.currentTurn = data.current_turn;
                                gameState.player_matched_cards = data.player_matched_cards;
                                gameState.ai_matched_cards = data.ai_matched_cards;
                                
                                if (newMatchedCards.length > 0) {
                                    // „Çπ„Ç≥„Ç¢Ë°®Á§∫„ÅÆ„ÅøÊõ¥Êñ∞
                                    document.getElementById('player-score').textContent = gameState.playerScore;
                                    document.getElementById('ai-score').textContent = gameState.aiScore;
                                    
                                    // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Âêë„Åç„Å´„Åô„Çã
                                    newMatchedCards.forEach(cardIndex => {
                                        const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                                        if (cardElement) {
                                            cardElement.classList.add('flipped');
                                        }
                                    });
                                    
                                    showSparkleEffect(newMatchedCards);
                                    
                                    // AI„Åå„Éû„ÉÉ„ÉÅ„Åó„ÅüÂ†¥Âêà„ÄÅ„Ç≠„É©„Ç≠„É©ÂäπÊûúÁµÇ‰∫ÜÂæå„Å´AI„ÅåÁ∂öË°å
                                    setTimeout(() => {
                                        if (gameState.currentTurn === 'ai') {
                                            handleAITurn();
                                        }
                                    }, 5000); // „Ç≠„É©„Ç≠„É©ÂäπÊûúÔºà4ÁßíÔºâ+ 1ÁßíÂæÖÊ©ü
                                } else {
                                    // „Éû„ÉÉ„ÉÅ„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÅØÈÄöÂ∏∏ÈÄö„ÇärenderGame„ÇíÂëº„Å∂
                                    renderGame();
                                }
                            } else {
                                // AI„Åå„Éû„ÉÉ„ÉÅ„Åó„Å™„Åã„Å£„ÅüÂ†¥Âêà„ÄÅ„Ç´„Éº„Éâ„ÇíË£èËøî„Åô„Éú„Çø„É≥„ÇíË°®Á§∫
                                gameState.currentTurn = data.current_turn;
                                document.getElementById('ai-btn').style.display = 'none';
                                document.getElementById('flip-back-btn').style.display = 'inline-block';
                            }
                        }, 1000);
                    } else {
                        // ÈÄöÂ∏∏„ÅÆÂá¶ÁêÜ
                        gameState.flipped = data.flipped;
                        gameState.matched = data.matched;
                        gameState.playerScore = data.player_score;
                        gameState.aiScore = data.ai_score;
                        gameState.currentTurn = data.current_turn;
                        gameState.player_matched_cards = data.player_matched_cards;
                        gameState.ai_matched_cards = data.ai_matched_cards;
                        renderGame();
                    }

                    // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                    checkGameEnd();
                })
                .catch(error => {
                    console.error('AI„Çø„Éº„É≥„Ç®„É©„Éº:', error);
                });
        }



        // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Á§∫
        function renderMatchedCards() {
            const playerMatchedCards = document.getElementById('player-matched-cards');
            const aiMatchedCards = document.getElementById('ai-matched-cards');
            
            // Êó¢Â≠ò„ÅÆ„Ç´„Éº„Éâ„Çí„ÇØ„É™„Ç¢
            playerMatchedCards.innerHTML = '';
            aiMatchedCards.innerHTML = '';
            
            // „Éó„É¨„Ç§„É§„Éº„Åå„Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Á§∫
            if (gameState.player_matched_cards) {
                gameState.player_matched_cards.forEach(cardIndex => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'matched-card';
                    cardElement.innerHTML = gameState.cards[cardIndex];
                    playerMatchedCards.appendChild(cardElement);
                });
            }
            
            // AI„Åå„Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Á§∫
            if (gameState.ai_matched_cards) {
                gameState.ai_matched_cards.forEach(cardIndex => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'matched-card';
                    cardElement.innerHTML = gameState.cards[cardIndex];
                    aiMatchedCards.appendChild(cardElement);
                });
            }
        }

        // „Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíË°®Á§∫
        function showSparkleEffect(matchedCardIndices) {
            console.log('„Ç≠„É©„Ç≠„É©ÂäπÊûúÈñãÂßã:', matchedCardIndices);
            // „Ç≠„É©„Ç≠„É©ÂäπÊûú‰∏≠„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            window.isSparkling = true;
            
            // „Åæ„Åö1ÁßíÈñì„ÄÅ„Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Âêë„Åç„ÅßË°®Á§∫Ôºà„Ç≠„É©„Ç≠„É©ÂäπÊûú„Å™„ÅóÔºâ
            setTimeout(() => {
                // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÅÆ‰ΩçÁΩÆ„Å´„Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíË°®Á§∫
                matchedCardIndices.forEach(cardIndex => {
                    const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                    if (cardElement) {
                        console.log(`„Ç´„Éº„Éâ ${cardIndex} „Å´„Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíÈÅ©Áî®`);
                        // „Ç´„Éº„Éâ„ÇíË°®Âêë„Åç„Å´„Åó„Å¶„Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíÈÅ©Áî®
                        cardElement.classList.add('flipped');
                        cardElement.classList.add('sparkle-effect');
                    } else {
                        console.log(`„Ç´„Éº„Éâ ${cardIndex} „ÅÆË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
                    }
                });
                
                // 4ÁßíÂæå„Å´„Ç≠„É©„Ç≠„É©ÂäπÊûú„ÇíÂâäÈô§„Åó„ÄÅ„Ç´„Éº„Éâ„ÇíÁ©∫ÁôΩ„Å´„Åó„Å¶„Ç¢„Ç§„Ç≥„É≥„Å´ÁßªÂãï
                setTimeout(() => {
                    matchedCardIndices.forEach(cardIndex => {
                        const cardElement = document.querySelector(`[data-index="${cardIndex}"]`);
                        if (cardElement) {
                            cardElement.classList.remove('sparkle-effect');
                            // „Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíÁ©∫ÁôΩ„Å´„Åô„Çã
                            cardElement.style.visibility = 'hidden';
                            console.log(`„Ç´„Éº„Éâ ${cardIndex} „ÅÆ„Ç≠„É©„Ç≠„É©ÂäπÊûúÁµÇ‰∫Ü`);
                        }
                    });
                    // „Ç≠„É©„Ç≠„É©ÂäπÊûú‰∏≠„Éï„É©„Ç∞„ÇíËß£Èô§
                    window.isSparkling = false;
                    // „Ç¢„Ç§„Ç≥„É≥„ÅÆÂ†¥ÊâÄ„Å´„Éû„ÉÉ„ÉÅ„Åó„Åü„Ç´„Éº„Éâ„ÇíË°®Á§∫
                    renderMatchedCards();
                    
                    // „Ç≠„É©„Ç≠„É©ÂäπÊûúÁµÇ‰∫ÜÂæå„Å´„Éú„Çø„É≥„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÁ¢∫Ë™ç
                    if (gameState.currentTurn === 'player') {
                        // „Éó„É¨„Ç§„É§„Éº„ÅÆ„Çø„Éº„É≥„ÅÆÂ†¥ÂêàÔºö„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
                        document.getElementById('flip-back-btn').style.display = 'none';
                        document.getElementById('ai-btn').style.display = 'none';
                    } else if (gameState.currentTurn === 'ai') {
                        // AI„ÅÆ„Çø„Éº„É≥„ÅÆÂ†¥ÂêàÔºöAI„ÅåÁ∂öË°å
                        setTimeout(() => {
                            handleAITurn();
                        }, 1000);
                    }
                }, 4000);
            }, 1000);
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
        function checkGameEnd() {
            const matchedCount = gameState.matched.filter(m => m).length;
            if (matchedCount === 20) {
                setTimeout(() => {
                    showGameOver();
                }, 1000);
            }
        }

        // „Ç≤„Éº„É†ÁµÇ‰∫ÜÁîªÈù¢Ë°®Á§∫
        function showGameOver() {
            const gameOver = document.getElementById('game-over');
            const gameResult = document.getElementById('game-result');
            const finalScore = document.getElementById('final-score');

            let resultText = '';
            if (gameState.playerScore > gameState.aiScore) {
                resultText = 'üéâ „ÅÇ„Å™„Åü„ÅÆÂãùÂà©ÔºÅ üéâ';
            } else if (gameState.playerScore < gameState.aiScore) {
                resultText = 'üòÖ AI„ÅÆÂãùÂà©...';
            } else {
                resultText = 'ü§ù Âºï„ÅçÂàÜ„ÅëÔºÅ';
            }

            gameResult.textContent = resultText;
            finalScore.textContent = `ÊúÄÁµÇ„Çπ„Ç≥„Ç¢: „ÅÇ„Å™„Åü ${gameState.playerScore} - ${gameState.aiScore} AI`;

            gameOver.style.display = 'flex';

            // „Ç≤„Éº„É†ÁµêÊûú„Çí‰øùÂ≠ò
            fetch('/api/save-game', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    player_score: gameState.playerScore,
                    ai_score: gameState.aiScore
                })
            });
        }

        // Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†ÈñãÂßã
        function startNewGame() {
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('flip-back-btn').style.display = 'none';
            document.getElementById('ai-btn').style.display = 'none';
            
            // „Ç∑„É£„ÉÉ„Éï„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫
            showShuffleAnimation();
        }

        // „Ç∑„É£„ÉÉ„Éï„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫
        function showShuffleAnimation() {
            const gameBoard = document.getElementById('game-board');
            const cards = gameBoard.querySelectorAll('.card');
            
            // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„Å´„Ç∑„É£„ÉÉ„Éï„É´ÂäπÊûú„ÇíÈÅ©Áî®
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('shuffle-effect');
                }, index * 50); // „Ç´„Éº„Éâ„Åî„Å®„Å´Â∞ë„Åó„Åö„Å§ÈÅÖÂª∂
            });
            
            // „Ç∑„É£„ÉÉ„Éï„É´„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÁµÇ‰∫ÜÂæå„Å´Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„ÇíÈñãÂßã
            setTimeout(() => {
                cards.forEach(card => {
                    card.classList.remove('shuffle-effect');
                });
                initGame();
            }, cards.length * 50 + 800); // ÂÖ®„Å¶„ÅÆ„Ç´„Éº„Éâ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ + „Ç∑„É£„ÉÉ„Éï„É´ÊôÇÈñì
        }



        // „Ç≤„Éº„É†Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadGameHistory() {
            fetch('/api/game-history')
                .then(response => response.json())
                .then(data => {
                    const historyList = document.getElementById('history-list');
                    historyList.innerHTML = '';

                    data.forEach(game => {
                        const item = document.createElement('li');
                        item.className = 'history-item';
                        item.innerHTML = `
                            <span>${game.created_at}</span>
                            <span>„ÅÇ„Å™„Åü ${game.player_score} - ${game.ai_score} AI</span>
                        `;
                        historyList.appendChild(item);
                    });
                });
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
        document.getElementById('new-game-btn').addEventListener('click', startNewGame);
        document.getElementById('ai-btn').addEventListener('click', handleAITurn);
        document.getElementById('flip-back-btn').addEventListener('click', flipBackCards);

        // ÂàùÊúüÂåñ
        initGame();
        loadGameHistory();
    </script>
</body>
</html> 